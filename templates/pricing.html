<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Real-time Pricing Demo</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .status-connected { color: #198754; }
        .status-disconnected { color: #dc3545; }
        .price-card { transition: all 0.3s ease; }
        .price-updated { 
            background-color: #fff3cd; 
            border: 2px solid #ffc107;
        }
        .pricing-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1rem; }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="/pricing">Real-time Pricing</a>
            <div class="navbar-nav">
                <a class="nav-link" href="/">Home</a>
                <a class="nav-link" href="/products">Products</a>
                <a class="nav-link active" href="/pricing">Pricing</a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- Connection Status -->
        <div class="row mb-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h5 class="card-title">Connection Status</h5>
                                <p class="mb-0">
                                    Status: <span id="connectionStatus" class="fw-bold">Connecting...</span><br>
                                    Cache: <span id="cacheInfo">0 products</span><br>
                                    Last Update: <span id="lastUpdate">Never</span>
                                </p>
                            </div>
                            <div>
                                <button id="reconnectBtn" class="btn btn-outline-primary me-2">Reconnect</button>
                                <button id="clearCacheBtn" class="btn btn-outline-warning me-2">Clear Cache</button>
                                <button id="testUpdateBtn" class="btn btn-outline-success">Test Update</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Search & Filter -->
        <div class="row mb-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <label for="skuSearch" class="form-label">Search SKU</label>
                                <input type="text" class="form-control" id="skuSearch" placeholder="Enter SKU...">
                            </div>
                            <div class="col-md-3">
                                <label for="materialFilter" class="form-label">Material</label>
                                <select class="form-control" id="materialFilter">
                                    <option value="">All Materials</option>
                                    <option value="gold">Gold</option>
                                    <option value="silver">Silver</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label for="strategySelect" class="form-label">Offline Strategy</label>
                                <select class="form-control" id="strategySelect">
                                    <option value="freeze">Freeze</option>
                                    <option value="surcharge">Surcharge (+5%)</option>
                                    <option value="deny">Deny</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Pricing Grid -->
        <div class="row">
            <div class="col-md-12">
                <h3>Live Pricing</h3>
                <div id="pricingGrid" class="pricing-grid">
                    <!-- Pricing cards sẽ được render ở đây -->
                </div>
                
                <!-- Empty state -->
                <div id="emptyState" class="text-center text-muted py-5" style="display: none;">
                    <h5>No pricing data available</h5>
                    <p>Connect to the pricing stream to see live updates</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Pricing Card Template -->
    <template id="pricingCardTemplate">
        <div class="card price-card" data-sku="">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h6 class="mb-0 sku-name"></h6>
                <span class="badge material-badge"></span>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-6">
                        <div class="price-info">
                            <div class="final-price h4 text-primary mb-1"></div>
                            <small class="text-muted">Final Price</small>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="base-price-info">
                            <div class="base-price h6 mb-1"></div>
                            <small class="text-muted">Base Price</small>
                        </div>
                    </div>
                </div>
                <hr class="my-2">
                <div class="row small">
                    <div class="col-6">
                        <div>Weight: <span class="weight"></span>g</div>
                        <div>Rate: <span class="rate"></span></div>
                    </div>
                    <div class="col-6">
                        <div>Labor: <span class="labor"></span></div>
                        <div>Markup: <span class="markup"></span>%</div>
                    </div>
                </div>
                <div class="mt-2">
                    <small class="text-muted">
                        Updated: <span class="updated-time"></span>
                        <span class="status-badges"></span>
                    </small>
                </div>
            </div>
        </div>
    </template>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/static/js/pricing_client.js"></script>
    <script>
        // Initialize pricing client
        const pricingClient = new PricingClient();
        
        // DOM elements
        const connectionStatus = document.getElementById('connectionStatus');
        const cacheInfo = document.getElementById('cacheInfo');
        const lastUpdate = document.getElementById('lastUpdate');
        const pricingGrid = document.getElementById('pricingGrid');
        const emptyState = document.getElementById('emptyState');
        const skuSearch = document.getElementById('skuSearch');
        const materialFilter = document.getElementById('materialFilter');
        const strategySelect = document.getElementById('strategySelect');
        
        // Event handlers
        pricingClient.onConnectionChange = (connected) => {
            connectionStatus.textContent = connected ? 'Connected' : 'Disconnected';
            connectionStatus.className = connected ? 'fw-bold status-connected' : 'fw-bold status-disconnected';
            updateCacheInfo();
        };
        
        pricingClient.onPricingUpdate = (type, pricing) => {
            console.log('Pricing update:', type, Object.keys(pricing).length, 'products');
            lastUpdate.textContent = new Date().toLocaleTimeString();
            renderPricingGrid();
        };
        
        pricingClient.onError = (error) => {
            console.error('Pricing client error:', error);
        };
        
        // Button handlers
        document.getElementById('reconnectBtn').onclick = () => {
            pricingClient.connect();
        };
        
        document.getElementById('clearCacheBtn').onclick = () => {
            pricingClient.clearCache();
            renderPricingGrid();
            updateCacheInfo();
        };
        
        document.getElementById('testUpdateBtn').onclick = async () => {
            try {
                await pricingClient.triggerTestUpdate();
                alert('Test update triggered!');
            } catch (error) {
                alert('Error triggering test update: ' + error.message);
            }
        };
        
        // Filter handlers
        skuSearch.oninput = renderPricingGrid;
        materialFilter.onchange = renderPricingGrid;
        
        function updateCacheInfo() {
            const status = pricingClient.getConnectionStatus();
            cacheInfo.textContent = `${status.validPricingCount}/${status.cacheSize} valid products`;
        }
        
        function renderPricingGrid() {
            const allPricing = pricingClient.getAllPricing();
            const searchTerm = skuSearch.value.toLowerCase();
            const materialFilter_val = materialFilter.value;
            
            // Filter pricing
            const filteredPricing = Object.entries(allPricing).filter(([sku, pricing]) => {
                const matchesSearch = !searchTerm || sku.toLowerCase().includes(searchTerm);
                const matchesMaterial = !materialFilter_val || pricing.material === materialFilter_val;
                return matchesSearch && matchesMaterial;
            });
            
            if (filteredPricing.length === 0) {
                pricingGrid.style.display = 'none';
                emptyState.style.display = 'block';
                return;
            }
            
            pricingGrid.style.display = 'grid';
            emptyState.style.display = 'none';
            
            // Render cards
            pricingGrid.innerHTML = '';
            filteredPricing.forEach(([sku, pricing]) => {
                const card = createPricingCard(sku, pricing);
                pricingGrid.appendChild(card);
            });
            
            updateCacheInfo();
        }
        
        function createPricingCard(sku, pricing) {
            const template = document.getElementById('pricingCardTemplate');
            const card = template.content.cloneNode(true);
            
            // Set data
            const cardElement = card.querySelector('.card');
            cardElement.dataset.sku = sku;
            
            card.querySelector('.sku-name').textContent = sku;
            card.querySelector('.material-badge').textContent = pricing.material;
            card.querySelector('.material-badge').className = `badge ${pricing.material === 'gold' ? 'bg-warning' : 'bg-secondary'}`;
            
            card.querySelector('.final-price').textContent = pricingClient.formatPrice(pricing.final_price);
            card.querySelector('.base-price').textContent = pricingClient.formatPrice(pricing.base_price);
            
            card.querySelector('.weight').textContent = pricing.weight_gram;
            card.querySelector('.rate').textContent = pricingClient.formatPrice(pricing.rate_used);
            card.querySelector('.labor').textContent = pricingClient.formatPrice(pricing.labor_cost);
            card.querySelector('.markup').textContent = pricing.markup_percent;
            
            card.querySelector('.updated-time').textContent = new Date(pricing.as_of).toLocaleTimeString();
            
            // Status badges
            const badges = [];
            if (!pricingClient.isPricingValid(pricing)) {
                badges.push('<span class="badge bg-warning ms-1">Expired</span>');
            }
            if (pricing.strategy_applied) {
                badges.push(`<span class="badge bg-info ms-1">${pricing.strategy_applied}</span>`);
            }
            card.querySelector('.status-badges').innerHTML = badges.join('');
            
            // Highlight if recently updated (trong 5 giây)
            const isRecent = (Date.now() - new Date(pricing.as_of).getTime()) < 5000;
            if (isRecent) {
                cardElement.classList.add('price-updated');
                setTimeout(() => {
                    cardElement.classList.remove('price-updated');
                }, 3000);
            }
            
            return card;
        }
        
        // Initial render
        setTimeout(renderPricingGrid, 1000);
        
        // Auto-refresh mỗi 30 giây
        setInterval(updateCacheInfo, 30000);
    </script>
</body>
</html>

{% extends "base.html" %}

{% block title %}Qu·∫£n l√Ω T·ª∑ gi√°{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row">
        <div class="col-md-12">
            <h2 class="mb-4">
                <i class="fas fa-coins text-warning me-2"></i>
                Qu·∫£n l√Ω T·ª∑ gi√° Real-time
            </h2>
        </div>
    </div>

    <div class="row">
        <!-- Input Form -->
        <div class="col-md-6">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-edit me-2"></i>
                        C·∫≠p nh·∫≠t T·ª∑ gi√°
                    </h5>
                </div>
                <div class="card-body">
                    <form id="rateForm">
                        <div class="mb-3">
                            <label for="material" class="form-label fw-bold">Lo·∫°i Kim lo·∫°i</label>
                            <select class="form-select" id="material" name="material" required>
                                <option value="">-- Ch·ªçn kim lo·∫°i --</option>
                                <option value="gold">ü•á V√†ng (Gold)</option>
                                <option value="silver">ü•à B·∫°c (Silver)</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label for="rate" class="form-label fw-bold">T·ª∑ gi√° (VND)</label>
                            <div class="input-group">
                                <input type="number" class="form-control" id="rate" name="rate" 
                                       min="1000" max="999999999" step="1000" 
                                       placeholder="75500000" required
                                       oninput="validateRateInput(this)">
                                <span class="input-group-text">VND</span>
                            </div>
                            <div class="form-text">Nh·∫≠p t·ª∑ gi√° m·ªõi (VD: 75,500,000 cho v√†ng, t·ª´ 1,000 ƒë·∫øn 999,999,999)</div>
                            <div id="rateValidation" class="invalid-feedback"></div>
                        </div>

                        <div class="d-grid">
                            <button type="submit" class="btn btn-primary btn-lg">
                                <i class="fas fa-paper-plane me-2"></i>
                                G·ª≠i T·ª∑ gi√° qua Kafka
                            </button>
                        </div>
                    </form>

                    <!-- Status Messages -->
                    <div id="statusMessages" class="mt-3"></div>
                </div>
            </div>
        </div>

        <!-- Current Rates Display -->
        <div class="col-md-6">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-chart-line me-2"></i>
                        T·ª∑ gi√° Hi·ªán t·∫°i
                    </h5>
                </div>
                <div class="card-body">
                    <div id="currentRates">
                        <div class="text-center">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mt-2">ƒêang t·∫£i t·ª∑ gi√°...</p>
                        </div>
                    </div>

                    <div class="mt-3">
                        <button class="btn btn-outline-success" onclick="loadCurrentRates()">
                            <i class="fas fa-sync-alt me-1"></i>
                            L√†m m·ªõi
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Real-time Updates -->
    <div class="row mt-4">
        <div class="col-md-12">
            <div class="card shadow-sm">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-broadcast-tower me-2"></i>
                        C·∫≠p nh·∫≠t Real-time
                        <span class="badge bg-light text-dark ms-2" id="connectionStatus">Disconnected</span>
                    </h5>
                </div>
                <div class="card-body">
                    <div id="realtimeUpdates">
                        <p class="text-muted">K·∫øt n·ªëi v·ªõi SSE ƒë·ªÉ nh·∫≠n updates real-time...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Global variables
let eventSource = null;

// Real-time validation cho rate input
function validateRateInput(input) {
    const value = parseFloat(input.value);
    const feedback = document.getElementById('rateValidation');
    
    input.classList.remove('is-invalid', 'is-valid');
    
    if (input.value && !isNaN(value)) {
        if (value < 1000) {
            input.classList.add('is-invalid');
            feedback.textContent = 'T·ª∑ gi√° t·ªëi thi·ªÉu l√† 1,000 VND';
            feedback.style.display = 'block';
        } else if (value > 999999999) {
            input.classList.add('is-invalid');
            feedback.textContent = 'T·ª∑ gi√° t·ªëi ƒëa l√† 999,999,999 VND';
            feedback.style.display = 'block';
        } else {
            input.classList.add('is-valid');
            feedback.style.display = 'none';
        }
    } else if (input.value) {
        input.classList.add('is-invalid');
        feedback.textContent = 'Vui l√≤ng nh·∫≠p s·ªë h·ª£p l·ªá';
        feedback.style.display = 'block';
    } else {
        feedback.style.display = 'none';
    }
}

// Form submission
document.getElementById('rateForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const material = document.getElementById('material').value;
    const rateInput = document.getElementById('rate').value;
    
    // Validation chi ti·∫øt h∆°n
    if (!material) {
        showMessage('Vui l√≤ng ch·ªçn lo·∫°i kim lo·∫°i', 'warning');
        return;
    }
    
    if (!rateInput || rateInput.trim() === '') {
        showMessage('Vui l√≤ng nh·∫≠p t·ª∑ gi√°', 'warning');
        return;
    }
    
    const rate = parseFloat(rateInput);
    if (isNaN(rate) || rate <= 0) {
        showMessage('T·ª∑ gi√° ph·∫£i l√† s·ªë d∆∞∆°ng h·ª£p l·ªá', 'warning');
        return;
    }
    
    if (rate < 1000) {
        showMessage('T·ª∑ gi√° qu√° th·∫•p (t·ªëi thi·ªÉu 1,000 VND)', 'warning');
        return;
    }
    
    if (rate > 999999999) {
        showMessage('T·ª∑ gi√° qu√° cao (t·ªëi ƒëa 999,999,999 VND)', 'warning');
        return;
    }
    
    try {
        showMessage('ƒêang g·ª≠i t·ª∑ gi√° qua Kafka...', 'info');
        
        const response = await fetch('/api/rates/update', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                material: material,
                rate: rate
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            showMessage(data.message, 'success');
            document.getElementById('rateForm').reset();
            
            // Reload current rates after 1 second
            setTimeout(() => {
                loadCurrentRates();
            }, 1000);
        } else {
            showMessage('L·ªói: ' + (data.detail || 'Unknown error'), 'danger');
        }
        
    } catch (error) {
        showMessage('L·ªói k·∫øt n·ªëi: ' + error.message, 'danger');
    }
});

// Load current rates
async function loadCurrentRates() {
    try {
        const response = await fetch('/api/rates/current');
        const data = await response.json();
        
        if (data.success) {
            displayCurrentRates(data.data);
        } else {
            document.getElementById('currentRates').innerHTML = 
                '<div class="alert alert-warning">Kh√¥ng th·ªÉ t·∫£i t·ª∑ gi√° hi·ªán t·∫°i</div>';
        }
    } catch (error) {
        document.getElementById('currentRates').innerHTML = 
            '<div class="alert alert-danger">L·ªói: ' + error.message + '</div>';
    }
}

// Display current rates
function displayCurrentRates(rates) {
    let html = '';
    
    if (Object.keys(rates).length === 0) {
        html = '<div class="alert alert-info">Ch∆∞a c√≥ d·ªØ li·ªáu t·ª∑ gi√°</div>';
    } else {
        html = '<div class="row">';
        
        Object.entries(rates).forEach(([material, rateData]) => {
            const icon = material === 'gold' ? 'ü•á' : 'ü•à';
            const colorClass = material === 'gold' ? 'text-warning' : 'text-secondary';
            const materialName = material === 'gold' ? 'V√†ng' : 'B·∫°c';
            
            html += `
                <div class="col-md-6 mb-3">
                    <div class="border rounded p-3 ${colorClass}">
                        <h6 class="fw-bold">${icon} ${materialName}</h6>
                        <div class="fs-4 fw-bold">${rateData.rate.toLocaleString()} VND</div>
                        <small class="text-muted">
                            C·∫≠p nh·∫≠t: ${new Date(rateData.timestamp).toLocaleString('vi-VN')}
                        </small>
                    </div>
                </div>
            `;
        });
        
        html += '</div>';
    }
    
    document.getElementById('currentRates').innerHTML = html;
}

// Show status messages
function showMessage(message, type) {
    const html = `
        <div class="alert alert-${type} alert-dismissible fade show" role="alert">
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `;
    document.getElementById('statusMessages').innerHTML = html;
    
    // Auto dismiss after 5 seconds
    setTimeout(() => {
        const alert = document.querySelector('#statusMessages .alert');
        if (alert) {
            alert.remove();
        }
    }, 5000);
}

// SSE connection for real-time updates
function connectSSE() {
    if (eventSource) {
        eventSource.close();
    }
    
    try {
        eventSource = new EventSource('/events/pricing');
        
        eventSource.onopen = function() {
            document.getElementById('connectionStatus').textContent = 'Connected';
            document.getElementById('connectionStatus').className = 'badge bg-success text-white ms-2';
            addRealtimeMessage('‚úÖ K·∫øt n·ªëi SSE th√†nh c√¥ng', 'success');
        };
        
        eventSource.onmessage = function(event) {
            try {
                const data = JSON.parse(event.data);
                handleRealtimeUpdate(data);
            } catch (e) {
                console.error('Error parsing SSE data:', e);
            }
        };
        
        eventSource.onerror = function() {
            document.getElementById('connectionStatus').textContent = 'Disconnected';
            document.getElementById('connectionStatus').className = 'badge bg-danger text-white ms-2';
            addRealtimeMessage('‚ùå M·∫•t k·∫øt n·ªëi SSE', 'warning');
        };
        
    } catch (error) {
        addRealtimeMessage('‚ùå L·ªói k·∫øt n·ªëi SSE: ' + error.message, 'danger');
    }
}

// Handle real-time updates
function handleRealtimeUpdate(data) {
    if (data.type === 'pricing_update' && data.pricing) {
        const sku = data.sku;
        const pricing = data.pricing;
        
        addRealtimeMessage(`üìä C·∫≠p nh·∫≠t gi√°: ${sku} = ${pricing.final_price.toLocaleString()} VND`, 'info');
        
        // Reload current rates if there are rate changes
        loadCurrentRates();
    }
}

// Add message to real-time updates
function addRealtimeMessage(message, type) {
    const timestamp = new Date().toLocaleTimeString('vi-VN');
    const colorClass = type === 'success' ? 'text-success' : 
                      type === 'warning' ? 'text-warning' : 
                      type === 'danger' ? 'text-danger' : 'text-info';
    
    const html = `
        <div class="border-bottom pb-2 mb-2">
            <small class="text-muted">${timestamp}</small>
            <div class="${colorClass}">${message}</div>
        </div>
    `;
    
    const updatesDiv = document.getElementById('realtimeUpdates');
    updatesDiv.insertAdjacentHTML('afterbegin', html);
    
    // Keep only last 10 messages
    const messages = updatesDiv.children;
    while (messages.length > 10) {
        messages[messages.length - 1].remove();
    }
}

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    loadCurrentRates();
    connectSSE();
});

// Cleanup on page unload
window.addEventListener('beforeunload', function() {
    if (eventSource) {
        eventSource.close();
    }
});
</script>
{% endblock %}
